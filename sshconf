#!/bin/zsh

VERSION=v3
FILENAME=${0##*/}
SSHDIR=${HOME}/.ssh
CONFDIR=${SSHDIR}/conf.d
CONFIG=${SSHDIR}/config

initialize() {
    local ORIGDIR=${CONFDIR}/10-original
    mkdir -p ${ORIGDIR}
    cp ${CONFIG} ${ORIGDIR}/config.sshconfig
    echo ${CONFIG} copy to ${ORIGDIR}/config.sshconfig
}

generate() {
    echo '## this file managed by ''sshconf''.' >! ${CONFIG}
    echo '## do not edit this file.' >> ${CONFIG}
    echo >> ${CONFIG}

    for CONFFILE in `find ${SSHDIR} -name '*.sshconf'`
    do {
        echo \#\# include: ${CONFFILE} | tee -a ${CONFIG}
        grep -v '^\s*#' ${CONFFILE} | grep -v '^\s*//' >> ${CONFIG}
        echo >> ${CONFIG}
    } done
    bash -c 'sudo cp -f ${HOME}/.ssh/config /root/.ssh/'
}

edit() {
    local _EDITOR=
    if [[ -z "$2" ]]; then {
        _EDITOR=${EDITOR}
    } else {
        _EDITOR="$2"
    } fi
    ${_EDITOR} ${CONFDIR}
}

man() {
    cat << EOS
${FILENAME} (-i|-g|-v|-h)
  -i, --init, --initialize    : initialize ~/.ssh/conf.d
  -g, --gen,  --generate      : generate ~/.ssh/config
  -e,         --edit [editor] : open ~/.ssh/conf.d in your favorite editor <3 
  -v,         --version       : show version
  -h,         --help          : show help
EOS
}

version() {
    echo ${FILENAME} ${VERSION}
}

main() {
    case "$1" in
        "-h" | "--help" | "" ) man "$@" ;;
        "-v" | "--version" ) version "$@" ;;
        "-g" | "--gen" | "--generate" ) generate "$@" ;;
        "-i" | "--init" | "--initialize" ) initialize "$@" ;;
        "-e" | "--edit" ) edit "$@" ;;
        * ) {
                echo "${FILENAME} ${0##*/}: unrecognized option '$1'"
                echo "try '${FILENAME} -h' for more information."
            } ;;
    esac
}
main "$@"
