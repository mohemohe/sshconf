#!/bin/zsh

VERSION=v4
FILENAME=${0##*/}
SSHDIR=${HOME}/.ssh
CONFDIR=${SSHDIR}/conf.d
CONFIG=${SSHDIR}/config

initialize() {
    local ORIGDIR=${CONFDIR}/10-original
    mkdir -p ${ORIGDIR}
    cp ${CONFIG} ${ORIGDIR}/config.sshconfig
    echo ${CONFIG} copy to ${ORIGDIR}/config.sshconfig
}

generate() {
    echo '## this file managed by ''sshconf''.' >! ${CONFIG}
    echo '## do not edit this file.' >> ${CONFIG}
    echo >> ${CONFIG}

    for CONFFILE in `find ${CONFDIR} -name '*.sshconf'`
    do {
        echo \#\# include: ${CONFFILE} | tee -a ${CONFIG}
        grep -v '^\s*#' ${CONFFILE} | grep -v '^\s*//' >> ${CONFIG}
        echo >> ${CONFIG}
    } done
    bash -c 'sudo cp -f ${HOME}/.ssh/config /root/.ssh/'
}

lxc_pregenerate() {
    local TARGETDIR="${CONFDIR}/89-lxc"
    local TARGETFILE="10-lxc-running.sshconf"
    rm -f "${TARGETDIR}/${TARGETFILE}" &> /dev/null
    mkdir -p ${TARGETDIR}
    touch "${TARGETDIR}/${TARGETFILE}"

    local IFS=$'\n'
    for CONTAINER in `lxc list --format csv`
    do {
        local RUNNING=`echo ${CONTAINER} | cut -d',' -f 2`
        if [[ "${RUNNING}" == "RUNNING" ]]; then {
            local HOST=`echo ${CONTAINER} | cut -d',' -f 1`
            local HOSTNAME=`echo ${CONTAINER} | cut -d',' -f 3 | cut -d' ' -f1`
            
            local USER=
            case "$HOST" in
                *ubuntu* ) {
                    USER='ubuntu'
                } ;;

                *centos* ) {
                    USER='ec2-user'
                }
            esac
            
            cat <<EOS >> "${TARGETDIR}/${TARGETFILE}"
Host ${HOST}.lxc
  Hostname ${HOSTNAME}
  Port 22
  User ${USER}
EOS
        } fi
    } done

    local RESULT=`cat ${TARGETDIR}/${TARGETFILE}`
    cat <<EOS
generated config:

${RESULT}
EOS
}

edit() {
    local _EDITOR=
    if [[ -z "$2" ]]; then {
        _EDITOR=${EDITOR}
    } else {
        _EDITOR="$2"
    } fi
    ${_EDITOR} ${CONFDIR}
}

man() {
    cat << EOS
${FILENAME} (-i|-g|-v|-h)
  -i, --init, --initialize      : initialize ~/.ssh/conf.d
  -g, --gen,  --generate        : generate ~/.ssh/config
              --lxc-pregenerate : pre-generate container of lxc to 89-lxc/10-lxc-running.sshconf.
  -e,         --edit [editor]   : open ~/.ssh/conf.d in your favorite editor <3 
  -v,         --version         : show version
  -h,         --help            : show help
EOS
}

version() {
    echo ${FILENAME} ${VERSION}
}

main() {
    case "$1" in
        "-h" | "--help" | "" ) man "$@" ;;
        "-v" | "--version" ) version "$@" ;;
        "-g" | "--gen" | "--generate" ) generate "$@" ;;
        "--lxc-pregenerate" ) lxc_pregenerate "$@" ;;
        "-i" | "--init" | "--initialize" ) initialize "$@" ;;
        "-e" | "--edit" ) edit "$@" ;;
        * ) {
                echo "${FILENAME} ${0##*/}: unrecognized option '$1'"
                echo "try '${FILENAME} -h' for more information."
            } ;;
    esac
}
main "$@"
