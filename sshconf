#!/bin/bash

NAME="sshconf"
VERSION="1.0"
SCRIPT="${0##*/}"

function _version() {
    echo "${NAME} ${VERSION}"
}

function _man() {
    cat <<EOF

USAGE:
${SCRIPT} [OPTIONS]

OPTIONS:
    -i, --initialize : create ~/.ssh/conf.d/ and current config copy to ~/.ssh/conf.d/10-original
    -g, --generate   : ~/.ssh/conf.d/**/*.sshconf marge into ~/.ssh/config
    -h, --help       : show help
    -v, --version    : show version
EOF
}

function _initialize() {
    mkdir -p ${HOME}/.ssh/conf.d/10-original
    cp ${HOME}/.ssh/config ${HOME}/.ssh/conf.d/10-original/config.sshconf
}

function _generate() {
    local SSHCONF_LIST=`find ${HOME}/.ssh/conf.d -name '*.sshconf'`
    cat <<EOS >| ${HOME}/.ssh/config
## this file generated by sshconf.
## DO NOT edit this file directly.

EOS

    for file in $SSHCONF_LIST; do {
        echo -n '## include: ' >> ${HOME}/.ssh/config
        echo $file >> ${HOME}/.ssh/config
        cat $file >> ${HOME}/.ssh/config
        echo >> ${HOME}/.ssh/config
    } done
}

function _main() {
    case "$1" in
        "-h" | "--help" ) {
            _version
            _man
        } ;;
        "-v" | "--version" ) {
            _version
        } ;;
        "-i" | "--initialize" ) {
            _initialize
        } ;;
        "-g" | "--generate" ) {
            _generate
        } ;;
        * ) {
            _version
            _man
        }
    esac
}
_main "$@"
